# üìö Sistema de Valida√ß√£o do Censo Escolar - Documenta√ß√£o Completa

## üéØ Vis√£o Geral

O Sistema de Valida√ß√£o do Censo Escolar √© uma aplica√ß√£o NestJS que valida arquivos de dados educacionais seguindo as especifica√ß√µes do INEP. O sistema utiliza uma arquitetura em camadas com valida√ß√µes estruturais, por registro e contextual.

---

## üèóÔ∏è Arquitetura do Sistema

### Estrutura Principal

```
src/
‚îú‚îÄ‚îÄ api/                           # Camada de API (Controllers, Guards, Interceptors)
‚îú‚îÄ‚îÄ common/                        # Interfaces, DTOs, Enums compartilhados
‚îú‚îÄ‚îÄ file-processing/               # Processamento de arquivos (parsers)
‚îú‚îÄ‚îÄ reports/                       # Gera√ß√£o de relat√≥rios de valida√ß√£o
‚îî‚îÄ‚îÄ validation/                    # ‚≠ê N√öCLEO DO SISTEMA ‚≠ê
    ‚îú‚îÄ‚îÄ engine/                    # Motor de valida√ß√£o principal
    ‚îú‚îÄ‚îÄ validators/                # Validadores espec√≠ficos por camada
    ‚îî‚îÄ‚îÄ rules/                     # Regras de valida√ß√£o por registro
```

---

## üîÑ Fluxo de Valida√ß√£o

### 1. Entrada do Arquivo

```typescript
// 3 pontos de entrada poss√≠veis:
POST /validation/validate-line     ‚Üí Valida√ß√£o linha √∫nica (sem contexto)
POST /validation/validate-file     ‚Üí Valida√ß√£o completa (com contexto)
POST /validation/upload           ‚Üí Upload + Valida√ß√£o completa
```

### 2. Processamento no ValidationEngineService

```typescript
validateFile(content, fileName, version) {
    // 1. Valida√ß√µes estruturais (arquivo como um todo)
    // 2. Valida√ß√µes de linha (cada registro individualmente)
    // 3. Valida√ß√µes contextuais (rela√ß√µes entre registros)
    // 4. Ordena√ß√£o e consolida√ß√£o dos erros
}
```

### 3. Camadas de Valida√ß√£o

#### üî¥ Camada 1: Valida√ß√£o Estrutural

- **Respons√°vel**: `StructuralValidatorService`
- **O que valida**:
  - **Codifica√ß√£o**: ISO-8859-1 (Latin-1) conforme especifica√ß√£o INEP
  - **Caracteres v√°lidos**: Apenas mai√∫sculas, n√∫meros e caracteres especiais
  - **Estrutura geral**: Presen√ßa de registro 99, sequ√™ncia correta
  - **Regras estruturais**: Escolas ativas devem ter todos os registros obrigat√≥rios

#### üü° Camada 2: Valida√ß√£o de Arquivo

- **Respons√°vel**: `FileValidatorService`
- **O que valida**:
  - Tamanho do arquivo (m√°x 20MB)
  - Formato (.txt)
  - Sequ√™ncia de registros

#### üü¢ Camada 3: Valida√ß√£o de Registro

- **Respons√°vel**: `RecordValidatorService` + regras espec√≠ficas
- **O que valida**:
  - N√∫mero de campos por registro
  - Tipos de dados (string, number, date)
  - Comprimento de campos
  - Padr√µes (regex)
  - Campos obrigat√≥rios

#### üîµ Camada 4: Valida√ß√£o Contextual

- **Respons√°vel**: Regras espec√≠ficas com contexto
- **O que valida**:
  - Rela√ß√µes entre registros (registro 40 precisa existir registro 30)
  - Valida√ß√µes condicionais (se transporte=1, campos 23-32 obrigat√≥rios)
  - Consist√™ncia de dados entre registros

---

## üß© Classes e Interfaces Principais

### üéõÔ∏è ValidationEngineService (Orquestrador)

```typescript
class ValidationEngineService {
  // PRINCIPAL: Valida√ß√£o completa com contexto
  async validateFile(content, fileName, version): Promise<ValidationResult>;

  // ALTERNATIVA: Valida√ß√£o sem contexto (tempo real)
  async validateSingleLine(
    line,
    recordTypeCode,
    version,
  ): Promise<{ errors; warnings }>;

  // INTERNO: Valida√ß√£o com contexto entre registros
  private async validateRecordsWithContext(records, fileName, version);
}
```

**Responsabilidades:**

- Coordenar todas as camadas de valida√ß√£o
- Manter contexto entre registros (escola, pessoa, turma)
- Aplicar regras condicionais baseadas em contexto
- Consolidar e ordenar erros/avisos

### üîß BaseRecordRule (Classe Base)

```typescript
abstract class BaseRecordRule {
  protected abstract fields: FieldRule[]; // Defini√ß√£o dos campos
  protected abstract recordType: RecordTypeEnum; // Tipo do registro

  // Valida√ß√£o b√°sica do registro
  validate(parts: string[], lineNumber: number): ValidationError[];

  // Valida√ß√£o com contexto (sobrescrita opcional)
  validateWithContext?(
    parts,
    schoolContext,
    classContext,
    personContext,
    lineNumber,
  );

  // Helpers para valida√ß√£o
  protected validateField(field, value, lineNumber, allParts);
  protected isConditionallyRequired(field, allParts);
  protected validateBusinessRules(parts, lineNumber);
}
```

**Como funciona:**

1. Define estrutura dos campos (`FieldRule[]`)
2. Valida cada campo individualmente
3. Aplica regras condicionais
4. Permite sobrescrita para valida√ß√µes espec√≠ficas

### üìã FieldRule (Defini√ß√£o de Campo)

```typescript
interface FieldRule {
  position: number; // Posi√ß√£o no registro (0-based)
  name: string; // Nome interno do campo
  required: boolean; // Obrigat√≥rio sempre?
  minLength?: number; // Tamanho m√≠nimo
  maxLength?: number; // Tamanho m√°ximo
  pattern?: RegExp; // Padr√£o regex
  type: 'string' | 'number' | 'date' | 'code'; // Tipo de dados
  description: string; // Descri√ß√£o amig√°vel
  conditionalRequired?: ConditionalRequired; // Obrigat√≥rio condicionalmente
}
```

**Exemplo pr√°tico:**

```typescript
{
    position: 20,                        // Campo 21 (posi√ß√£o 20 em array 0-based)
    name: 'transporte_publico',
    required: false,
    minLength: 1,
    maxLength: 1,
    pattern: /^[01]$/,
    type: 'code',
    description: 'Utiliza transporte p√∫blico',
    conditionalRequired: undefined       // Sempre opcional
},
{
    position: 22,                        // Campo 23 (posi√ß√£o 22 em array 0-based)
    name: 'poder_publico_rodoviario',
    required: false,
    minLength: 1,
    maxLength: 1,
    pattern: /^[01]$/,
    type: 'code',
    description: 'Transporte rodovi√°rio - Poder P√∫blico',
    conditionalRequired: {               // Obrigat√≥rio SE:
        field: 'transporte_publico',     // Campo "transporte_publico"
        values: ['1']                    // = '1' (usa transporte)
    }
}
```

### üîÑ Contextos para Valida√ß√£o

#### SchoolContext (Registro 00)

```typescript
interface SchoolContext {
  codigoInep: string; // C√≥digo da escola
  situacaoFuncionamento: string; // 1=Ativa, 2=Paralisada, 3=Extinta
  dependenciaAdministrativa: string; // 1=Federal, 2=Estadual, etc.
  localizacaoDiferenciada?: number; // Campo 20: Localiza√ß√£o diferenciada
}
```

#### PersonContext (Registro 30)

```typescript
interface PersonContext {
  codigoPessoa: string; // C√≥digo √∫nico da pessoa
  identificacaoInep?: string; // ID no INEP
  paisResidencia?: number; // Campo 51: Pa√≠s (76=Brasil)
  enrolledClasses?: string[]; // Turmas onde est√° matriculado
}
```

#### ClassContext (Registro 20)

```typescript
interface ClassContext {
  codigoTurma: string; // C√≥digo da turma
  mediacao?: number; // Campo 6: Media√ß√£o did√°tica
  etapa?: number; // Campo 26: Etapa de ensino
  curricular?: boolean; // Campo 14: Turma curricular
  atendimentoEducacionalEspecializado?: boolean; // Campo 16: AEE
  atividadeComplementar?: boolean; // Campo 19: Atividade complementar
  itinerarioFormativo?: boolean; // Campo 35: Itiner√°rio formativo
  itinerarioProfissional?: boolean; // Campo 36: Itiner√°rio profissional
  areasConhecimento?: { [key: string]: boolean }; // Campos 43-69
}
```

---

## üé≠ Tipos de Valida√ß√£o por Registro

### Registro 00 - Identifica√ß√£o da Escola

- **Classe**: `SchoolIdentificationRule`
- **Campos**: 56 campos
- **Valida√ß√µes especiais**:
  - Data in√≠cio/fim atividades
  - Consist√™ncia de endere√ßo
  - C√≥digos IBGE v√°lidos

### Registro 10 - Caracteriza√ß√£o da Escola

- **Classe**: `SchoolCharacterizationRule`
- **Campos**: 187 campos
- **Valida√ß√µes especiais**:
  - Infraestrutura condicionada por depend√™ncia administrativa
  - Equipamentos condicionados por etapas oferecidas
  - Recursos tecnol√≥gicos consistentes

### Registro 20 - Turmas

- **Classe**: `ClassesRule`
- **Campos**: 70 campos
- **Valida√ß√µes especiais**:
  - Etapa vs modalidade de ensino
  - √Åreas de conhecimento vs itiner√°rio
  - Media√ß√£o did√°tica vs etapa

### Registro 30 - Pessoa F√≠sica

- **Classe**: `PhysicalPersonsRule`
- **Campos**: 108 campos
- **Valida√ß√µes especiais**:
  - CPF v√°lido (algoritmo)
  - Consist√™ncia nacionalidade vs pa√≠s
  - Escolaridade vs data nascimento

### Registro 40 - V√≠nculo Gestor Escolar

- **Classe**: `SchoolManagerBondRule`
- **Campos**: 7 campos
- **Valida√ß√µes contextuais**:
  - Pessoa deve existir (registro 30)
  - M√°ximo 3 gestores por escola
  - Cargo vs fun√ß√£o de confian√ßa

### Registro 50 - V√≠nculo Profissional Escolar

- **Classe**: `SchoolProfessionalBondRule`
- **Campos**: 38 campos
- **Valida√ß√µes contextuais**:
  - Pessoa deve existir (registro 30)
  - Turma deve existir (registro 20)
  - Fun√ß√£o vs √°rea de conhecimento
  - Itiner√°rio formativo vs disciplina

### Registro 60 - Matr√≠cula do Aluno

- **Classe**: `StudentEnrollmentRule`
- **Campos**: 32 campos
- **Valida√ß√µes contextuais**:
  - Pessoa deve existir (registro 30)
  - Turma deve existir (registro 20)
  - Transporte p√∫blico ‚Üí campos transporte obrigat√≥rios
  - AEE ‚Üí campos espec√≠ficos do AEE
  - Escolariza√ß√£o em casa vs localiza√ß√£o diferenciada

---

## üö¶ Valida√ß√µes Condicionais (Exemplos Pr√°ticos)

### 1. Transporte Escolar (Registro 60)

```typescript
// Campo 21: Utiliza transporte p√∫blico
{ name: 'transporte_publico', required: false, pattern: /^[01]$/ }

// Campos 23-32: SE transporte_publico = '1', ENT√ÉO obrigat√≥rios
{
    name: 'poder_publico_rodoviario',
    conditionalRequired: { field: 'transporte_publico', values: ['1'] }
}
```

### 2. AEE - Atendimento Educacional Especializado

```typescript
// Turma (registro 20): Campo 16 = AEE (0=N√£o, 1=Sim)
// Aluno (registro 60): SE turma.AEE = 1, ENT√ÉO campos AEE espec√≠ficos

if (classContext?.specializedEducationalService) {
  // Valida√ß√µes espec√≠ficas para turmas de AEE
  errors.push(...this.validateAEEFields(parts, lineNumber));
}
```

### 3. Campos que N√ÉO devem ser preenchidos

```typescript
// Exemplo: Campo s√≥ pode ser preenchido se depend√™ncia = Federal
const field = { maxLength: 0 }; // maxLength: 0 = n√£o deve ter valor

if (fieldValue && field.maxLength === 0) {
  errors.push({
    errorMessage: 'Este campo n√£o deve ser preenchido para esta situa√ß√£o',
  });
}
```

---

## üîç Valida√ß√µes Estruturais (Arquivo como um todo)

### SchoolStructureRule - Estrutura por Escola

```typescript
// Escola ATIVA (situa√ß√£o = 1) ‚Üí deve ter registros 00, 10, 20, 30, 40
// Escola PARALISADA/EXTINTA (situa√ß√£o = 2,3) ‚Üí deve ter apenas 00, 30, 40

if (situacao === '1') {
  const missingRecords = [];
  if (!school.hasRecord00) missingRecords.push('00');
  if (!school.hasRecord10) missingRecords.push('10');
  if (!school.hasRecord20) missingRecords.push('20');
  if (!school.hasRecord30) missingRecords.push('30');
  if (!school.hasRecord40) missingRecords.push('40');

  if (missingRecords.length > 0) {
    errors.push({
      errorMessage: `Escolas em atividade devem ter registros: ${missingRecords.join(', ')}`,
    });
  }
}
```

### Outras Valida√ß√µes Estruturais

- **Sequ√™ncia de registros**: 00 ‚Üí 10 ‚Üí 20 ‚Üí 30 ‚Üí 40,50,60 ‚Üí 99
- **Relacionamentos**: Toda turma (20) deve ter pelo menos 1 aluno (60) e 1 profissional (50)
- **Limites**: M√°ximo 1.500 turmas por escola, m√°ximo 3 gestores
- **Codifica√ß√£o**: Arquivo deve ser ISO-8859-1 (Latin-1) sem BOM

#### üìù Sobre a Codifica√ß√£o ISO-8859-1

**Conforme especifica√ß√£o INEP:**
> "Deve ser utilizado o padr√£o ISO-8859-1 de codifica√ß√£o de caracteres."

**Caracter√≠sticas:**
- ‚úÖ Suporta caracteres de 0x00 a 0xFF (256 caracteres)
- ‚úÖ Inclui acentos portugueses: √Ä, √Å, √É, √á, √â, √ç, √ì, √ö, etc.
- ‚ùå **N√ÉO usar UTF-8** (incompat√≠vel com validadores INEP)
- ‚ùå N√£o deve ter BOM (Byte Order Mark)

**Caracteres v√°lidos nos campos:**
- Letras: **A-Z** (apenas mai√∫sculas)
- N√∫meros: **0-9** 
- Especiais: **espa√ßo, h√≠fen (-), barra (/), etc.**
- ‚ùå Min√∫sculas (a-z) s√£o convertidas automaticamente ou geram erro

---

## üìä Tipos de Erro e Severidade

### Severidade dos Erros

```typescript
enum ValidationSeverity {
  ERROR = 'error', // Impede o envio ao INEP
  WARNING = 'warning', // Permite envio com ressalva
  INFO = 'info', // Informativo apenas
}
```

### Categorias de Erro

1. **Estruturais** (lineNumber: 0): Arquivo/estrutura geral
2. **De Campo** (lineNumber: N): Campo espec√≠fico de uma linha
3. **Contextuais** (lineNumber: N): Rela√ß√£o entre registros
4. **De Formato** (lineNumber: N): Tipo/padr√£o do campo

### Exemplo de ValidationError

```typescript
{
    lineNumber: 150,                              // Linha do arquivo
    recordType: 'STUDENT_ENROLLMENT',             // Tipo do registro
    fieldName: 'poder_publico_rodoviario',        // Nome interno
    fieldDescription: 'Transporte rodovi√°rio - Poder P√∫blico',  // Descri√ß√£o amig√°vel
    fieldPosition: 22,                            // Posi√ß√£o no array (0-based)
    fieldValue: '',                               // Valor encontrado
    ruleName: 'required_field',                   // Regra violada
    errorMessage: 'Transporte rodovi√°rio - Poder P√∫blico √© obrigat√≥rio quando utiliza transporte p√∫blico',
    severity: 'error'                             // N√≠vel do erro
}
```

---

## üéÆ Como Usar - Casos de Uso

### 1. Valida√ß√£o em Tempo Real (Frontend)

```typescript
// Para feedback imediato durante digita√ß√£o
const response = await fetch('/validation/validate-line', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    recordType: '30',
    line: '30|12345678|DIR001|12345678901|...',
    version: '2025',
  }),
});

// Retorna: { errors: ValidationError[], warnings: ValidationError[] }
```

### 2. Valida√ß√£o Completa de Arquivo

```typescript
// Para valida√ß√£o final antes do envio
const response = await fetch('/validation/validate-file', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    content: 'conte√∫do completo do arquivo...',
    version: '2025',
  }),
});

// Retorna: ValidationResult completo com contexto
```

### 3. Upload com Valida√ß√£o

```typescript
// Para upload de arquivos
const formData = new FormData();
formData.append('file', arquivo);
formData.append('version', '2025');

const response = await fetch('/validation/upload', {
  method: 'POST',
  body: formData,
});

// Retorna: ValidationResult + FileMetadata
```

---

## üõ†Ô∏è Como Adicionar Nova Valida√ß√£o

### 1. Campo Simples

```typescript
// Em qualquer *Rule class, adicionar ao array fields:
{
    position: 25,                        // Posi√ß√£o no registro
    name: 'novo_campo',
    required: true,                      // Sempre obrigat√≥rio
    maxLength: 10,
    pattern: /^[A-Z]+$/,                // S√≥ letras mai√∫sculas
    type: 'string',
    description: 'Descri√ß√£o do Novo Campo'
}
```

### 2. Campo Condicional

```typescript
{
    position: 26,
    name: 'campo_condicional',
    required: false,                     // N√£o sempre obrigat√≥rio
    maxLength: 5,
    type: 'code',
    description: 'Campo Condicional',
    conditionalRequired: {               // Obrigat√≥rio SE:
        field: 'novo_campo',             // novo_campo
        values: ['ATIVO', 'ESPECIAL']    // IN ('ATIVO', 'ESPECIAL')
    }
}
```

### 3. Valida√ß√£o de Neg√≥cio Complexa

```typescript
// Sobrescrever m√©todo validateBusinessRules na regra espec√≠fica:
protected validateBusinessRules(parts: string[], lineNumber: number): ValidationError[] {
    const errors: ValidationError[] = [];

    const campoA = parts[10] || '';
    const campoB = parts[15] || '';

    // Regra: Se A = '1', ent√£o B deve ser diferente de '0'
    if (campoA === '1' && campoB === '0') {
        errors.push(this.createError(
            lineNumber,
            'campoB',
            'Campo B',
            15,
            campoB,
            'business_rule_A_B',
            'Quando Campo A √© 1, Campo B n√£o pode ser 0',
            ValidationSeverity.ERROR
        ));
    }

    return errors;
}
```

### 4. Valida√ß√£o Contextual Entre Registros

```typescript
// Sobrescrever m√©todo validateWithContext:
validateWithContext(
    parts: string[],
    schoolContext: SchoolContext,
    classContext: ClassContext,
    personContext: PersonContext,
    lineNumber: number
): ValidationError[] {
    const errors = this.validate(parts, lineNumber); // Valida√ß√£o b√°sica

    // Valida√ß√£o contextual
    const codigoPessoa = parts[2] || '';
    if (!personContext) {
        errors.push(this.createError(
            lineNumber,
            'codigo_pessoa',
            'C√≥digo da Pessoa',
            2,
            codigoPessoa,
            'person_not_found',
            'Pessoa n√£o encontrada no registro 30',
            ValidationSeverity.ERROR
        ));
    }

    return errors;
}
```

---

## üîß Manuten√ß√£o e Troubleshooting

### Problemas Comuns

1. **Campo n√£o aparece como obrigat√≥rio quando deveria**
   - Verificar `conditionalRequired` est√° configurado corretamente
   - Conferir se o campo de refer√™ncia tem o nome exato
   - Debugar com `console.log` o valor do campo de refer√™ncia

2. **Erro "campo deveria n√£o ser preenchido" gen√©rico**
   - Campo tem `maxLength: 0` ‚Üí n√£o deve ter valor
   - Implementar valida√ß√£o espec√≠fica com mensagem clara

3. **Valida√ß√£o contextual n√£o funciona**
   - Verificar se a regra sobrescreve `validateWithContext`
   - Confirmar que o contexto est√° sendo criado corretamente
   - Validar ordem dos registros (contexto deve ser criado antes)

### Debug e Logs

```typescript
// Para debug durante desenvolvimento:
console.log('Contexto escola:', schoolContext);
console.log('Contexto pessoa:', personContext);
console.log('Valor campo refer√™ncia:', parts[refField.position]);
console.log('Campo obrigat√≥rio?', this.isConditionallyRequired(field, parts));
```

### Testes

```typescript
// Criar arquivo test-[funcionalidade].js para testar:
const parts = ['60', 'escola', 'pessoa', 'turma', '1' /* ... campos ... */];
const errors = rule.validateWithContext(
  parts,
  schoolCtx,
  classCtx,
  personCtx,
  1,
);
console.log('Erros encontrados:', errors.length);
```

---

## üìà Performance e Otimiza√ß√µes

### Valida√ß√£o R√°pida vs Completa

| Tipo            | Tempo    | Valida√ß√µes   | Uso             |
| --------------- | -------- | ------------ | --------------- |
| `validate-line` | 50-100ms | Sem contexto | Tempo real      |
| `validate-file` | 500ms-2s | Com contexto | Valida√ß√£o final |

### Early Stopping

- Erros estruturais cr√≠ticos ‚Üí para o processamento
- Campo obrigat√≥rio vazio ‚Üí n√£o valida outros aspectos do campo
- Tipo de registro inv√°lido ‚Üí n√£o valida campos espec√≠ficos

### Otimiza√ß√µes Aplicadas

- Valida√ß√£o em camadas com curto-circuito
- Contextos criados uma vez e reutilizados
- Ordena√ß√£o de erros por linha para facilitar corre√ß√£o
- Separa√ß√£o entre erros e avisos

---

## üéØ Resumo Executivo

**O que o sistema faz:**
‚úÖ Valida arquivos do Censo Escolar 2025 conforme especifica√ß√µes INEP  
‚úÖ Oferece 3 modos: linha √∫nica, arquivo completo, upload  
‚úÖ Aplica valida√ß√µes estruturais, de campo e contextuais  
‚úÖ Gera relat√≥rios detalhados com erros espec√≠ficos e acion√°veis

**Como est√° organizado:**
üèóÔ∏è Arquitetura em camadas (Estrutural ‚Üí Arquivo ‚Üí Registro ‚Üí Contextual)  
üìã Regras baseadas em FieldRule com valida√ß√µes condicionais  
üîÑ Contextos mantidos entre registros para valida√ß√µes cruzadas  
‚ö° Otimizado para performance com early stopping

**Como usar:**
üöÄ `/validate-line` ‚Üí valida√ß√£o r√°pida para feedback em tempo real  
üìÑ `/validate-file` ‚Üí valida√ß√£o completa com contexto para arquivos  
üì§ `/upload` ‚Üí upload + valida√ß√£o completa para interfaces web

**Como estender:**
‚ûï Adicionar campos ‚Üí definir FieldRule  
üîß Regras condicionais ‚Üí configurar conditionalRequired  
üéØ Valida√ß√µes complexas ‚Üí sobrescrever validateBusinessRules  
üîó Valida√ß√µes contextuais ‚Üí sobrescrever validateWithContext

---

_Sistema desenvolvido com NestJS, TypeScript e arquitetura modular para facilitar manuten√ß√£o e extensibilidade._
